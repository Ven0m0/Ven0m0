name: Generate Stats Images

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"
  push:
    branches: [main]
    paths:
      - 'scripts/generate_stats_images.py'
      - '.github/workflows/github-stats.yml'

concurrency:
  group: github-stats
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7
        with:
          enable-cache: true

      - name: Generate stats images
        env:
          PYTHONOPTIMIZE: "1"
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.repository_owner }}
          EXCLUDED: ${{ secrets.EXCLUDED }}
          EXCLUDED_LANGS: ${{ secrets.EXCLUDED_LANGS }}
          COUNT_STATS_FROM_FORKS: ${{ secrets.COUNT_STATS_FROM_FORKS }}
          OUTPUT_DIR: images
        run: uv run --python 3.13 --with 'aiohttp>=3.11,<4' scripts/generate_stats_images.py

      - name: Commit stats
        uses: ./.github/actions/git-auto-commit
        with:
          commit_message: "chore: update stats images"
          file_pattern: "images/overview.svg images/languages.svg images/github-stats.svg"
